//<LICENSE>

#ifndef MORPHSPOTCLEANDLG_H
#define MORPHSPOTCLEANDLG_H
#include "StdPreprocModulesGUI_global.h"
#include <QDialog>

#include <base/timage.h>
#include <morphology/morphology.h>

#include <ConfigBase.h>
#include <ConfiguratorDialogBase.h>

#include <imageviewerwidget.h>
#include <plotter.h>

#include <MorphSpotCleanModule.h>
#include <MorphSpotClean.h>


namespace Ui {
class MorphSpotCleanDlg;
}

class MorphSpotCleanDlg : public ConfiguratorDialogBase
{
    Q_OBJECT

public:
    explicit MorphSpotCleanDlg(QWidget *parent = nullptr);
    virtual ~MorphSpotCleanDlg();
    virtual int exec(ConfigBase * config, std::map<std::string, std::string> &parameters, kipl::base::TImage<float,3> & img);

private slots:

    void on_buttonApply_clicked();

    void on_comboDetectionDisplay_currentIndexChanged(int index);

    void on_comboDetectionMethod_currentIndexChanged(int index);

private:
    Ui::MorphSpotCleanDlg *ui;

private:
    virtual void ApplyParameters();
    void prepareDetectionPlot(kipl::base::TImage<float,2> &img,
                              int det,
                              size_t N,
                              float threshold,
                              float sigma,
                              std::string curvelabel,
                              std::string threslabel);

    virtual void UpdateDialog();
    virtual void UpdateParameters();
    void UpdateParameterList(std::map<std::string, std::string> &parameters);


    ReconConfig *config;
    MorphSpotCleanModule m_Cleaner;
    kipl::base::TImage<float,3> m_Projections;
    kipl::base::eConnectivity m_eConnectivity;
    ImagingAlgorithms::eMorphDetectionMethod m_eDetectionMethod;
    ImagingAlgorithms::eMorphCleanMethod m_eCleanMethod;

    kipl::base::TImage<float,2> m_OriginalImage;
    kipl::base::TImage<float,2> m_ProcessedImage;
    kipl::base::TImage<float,2> m_DetectionImageHoles;
    kipl::base::TImage<float,2> m_DetectionImagePeaks;

    float m_fThreshold[2];
    float m_fSigma[2];
    int   m_nEdgeSmoothLength;
    int   m_nMaxArea;
    bool  m_bRemoveInfNaN;
    bool  m_bClampData;
    float m_fMinLevel;
    float m_fMaxLevel;
    bool  m_bThreading;
    bool  m_bThresholdByFraction;
    bool  m_bTranspose;
};

#endif // MORPHSPOTCLEANDLG_H
